name: ğŸŒŸ GitHub Stars IndexåŒæ­¥

on:
  # â”€â”€ å®šæ—¶è§¦å‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # ä¿®æ”¹ä¸‹æ–¹ cron è¡¨è¾¾å¼ä»¥è‡ªå®šä¹‰æ‰§è¡Œé¢‘ç‡ï¼ˆUTC æ—¶é—´ï¼‰
  # ç¤ºä¾‹:
  #   "0 2 * * 1"   â†’ æ¯å‘¨ä¸€ UTC 02:00ï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
  #   "0 18 * * *"  â†’ æ¯å¤© UTC 18:00ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥ 02:00ï¼‰
  #   "0 2 1 * *"   â†’ æ¯æœˆ 1 æ—¥ UTC 02:00
  # cron åœ¨çº¿ç”Ÿæˆå™¨: https://crontab.guru
  schedule:
    - cron: "0 0 * * *"   # â† åœ¨æ­¤ä¿®æ”¹ä½ çš„å®šæ—¶é¢‘ç‡

  # â”€â”€ æ‰‹åŠ¨è§¦å‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ‰€æœ‰æ‘˜è¦ï¼ˆé‡å»º JSON æ•°æ®é›†ï¼‰"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      test_limit:
        description: "æµ‹è¯•æ¨¡å¼ï¼šé™åˆ¶å¤„ç†çš„é¡¹ç›®æ•°é‡ï¼ˆå¦‚å¡« 5 åˆ™åªå¤„ç† 5 ä¸ªæ–°é¡¹ç›®ï¼Œç•™ç©ºä¸é™åˆ¶ï¼‰"
        required: false
        default: ""
        type: string

permissions:
  contents: write   # å…è®¸ Action æäº¤æ–‡ä»¶åˆ°æœ¬ä»“åº“

jobs:
  sync:
    name: æŠ“å– Stars å¹¶ç”Ÿæˆæ‘˜è¦
    runs-on: ubuntu-latest
    timeout-minutes: 120   # è¶…æ—¶ä¿æŠ¤ï¼ˆStars è¾ƒå¤šæ—¶å¯èƒ½è€—æ—¶é•¿ï¼‰

    steps:
      # â”€â”€ 1. æ£€å‡ºä»£ç  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Checkout ä»“åº“
        uses: actions/checkout@v4

      # â”€â”€ 2. è®¾ç½® Python ç¯å¢ƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: è®¾ç½® Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      # â”€â”€ 3. å®‰è£…ä¾èµ– â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: å®‰è£…ä¾èµ–
        run: pip install -r requirements.txt

      # â”€â”€ 4. å¯é€‰ï¼šå¼ºåˆ¶é‡ç½®æ•°æ®é›† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: é‡ç½®æ•°æ®é›†ï¼ˆä»…åœ¨ force_rebuild=true æ—¶æ‰§è¡Œï¼‰
        if: github.event.inputs.force_rebuild == 'true'
        run: |
          echo "âš ï¸ å¼ºåˆ¶é‡å»ºæ¨¡å¼ï¼šåˆ é™¤ç°æœ‰æ•°æ®"
          rm -rf data/stars.json

      # â”€â”€ 5. æ‰§è¡ŒåŒæ­¥è„šæœ¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: åŒæ­¥ GitHub Stars
        env:
          # â”€â”€ Secretsï¼ˆæœºå¯†ï¼ŒåŠ å¯†ä¿å­˜ï¼‰â”€â”€
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}    # Actions è‡ªåŠ¨æ³¨å…¥ï¼Œæ— éœ€æ‰‹åŠ¨æ·»åŠ 
          AI_API_KEY: ${{ secrets.AI_API_KEY }}        # AI API Key
          VAULT_PAT: ${{ secrets.VAULT_PAT }}          # Vault ä»“åº“å†™æƒé™ PATï¼ˆVault åŒæ­¥æ—¶å¿…å¡«ï¼‰

          # â”€â”€ Variablesï¼ˆéæœºå¯†ï¼Œæ˜æ–‡ï¼Œåœ¨ Settings â†’ Variables ä¸­é…ç½®ï¼‰â”€â”€
          GH_USERNAME: ${{ vars.GH_USERNAME }}         # è¦æŠ“å– Stars çš„ GitHub ç”¨æˆ·å
          AI_BASE_URL: ${{ vars.AI_BASE_URL }}         # AI æ¥å£åœ°å€
          AI_MODEL: ${{ vars.AI_MODEL }}
          MAX_CONCURRENCY: ${{ vars.MAX_CONCURRENCY }}
          OUTPUT_FILENAME: ${{ vars.OUTPUT_FILENAME }}
          VAULT_SYNC_ENABLED: ${{ vars.VAULT_SYNC_ENABLED }}
          VAULT_REPO: ${{ vars.VAULT_REPO }}
          VAULT_SYNC_PATH: ${{ vars.VAULT_SYNC_PATH }}
          TEST_LIMIT: ${{ github.event.inputs.test_limit }}
          PAGES_SYNC_ENABLED: ${{ vars.PAGES_SYNC_ENABLED }}
        run: python scripts/sync_stars.py

      # â”€â”€ 6. æäº¤å˜æ›´åˆ°æœ¬ä»“åº“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: æäº¤å¹¶æ¨é€å˜æ›´
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/stars.json
          
          # å¦‚æœæ²¡æœ‰å˜åŒ–åˆ™è·³è¿‡ commitï¼ˆé¿å…ç©ºæäº¤æŠ¥é”™ï¼‰
          git diff --staged --quiet && echo "âœ… æ— æ–°å†…å®¹ï¼Œè·³è¿‡æäº¤" || \
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° GitHub Stars æ‘˜è¦ [$(date -u '+%Y-%m-%d %H:%M UTC')]"
          git push

      # â”€â”€ 7. éƒ¨ç½²åˆ° GitHub Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: éƒ¨ç½²åˆ° GitHub Pages
        if: vars.PAGES_SYNC_ENABLED == 'true'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist           # åŒæ­¥ dist æ–‡ä»¶å¤¹çš„å†…å®¹
          branch: gh-pages      # ç›®æ ‡åˆ†æ”¯
          clean: true           # ä¿æŒåˆ†æ”¯æ•´æ´
